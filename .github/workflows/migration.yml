name: Export GitLab Repos

on:
  workflow_dispatch:
  issues:
    types: [opened]

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract project names from issue
        if: github.event_name == 'issues'
        run: |
          echo "Extracting project names and namespaces from issue..."
          echo "${{ github.event.issue.body }}" > issue_body.txt
          # Extract comma-separated values from the issue body and sanitize any newlines or problematic characters
          cat issue_body.txt | grep -oP '[^,]*,[^,]*' | tr '\n' ',' > export_list.csv
          echo "Generated export_list.csv with the following contents:"
          cat export_list.csv

      - name: Make output directory
        run: mkdir -p output

      - name: Move CSV to output directory
        run: mv export_list.csv output/

      - name: Verify CSV file contents
        run: |
          echo "Checking contents of output/export_list.csv:"
          cat output/export_list.csv

      - name: Set up GitLab variables
        run: |
          echo "GITLAB_TOKEN=${{ secrets.GITLAB_TOKEN }}" >> $GITHUB_ENV
          echo "GITLAB_API_PRIVATE_TOKEN=${{ secrets.GITLAB_API_PRIVATE_TOKEN }}" >> $GITHUB_ENV
          echo "GITLAB_API_ENDPOINT=${{ secrets.GITLAB_API_ENDPOINT }}" >> $GITHUB_ENV
          echo "GITLAB_USERNAME=${{ secrets.GITLAB_USERNAME }}" >> $GITHUB_ENV

      - name: Make migration script executable
        run: chmod +x gitlab-exporter.sh

      - name: Run GitLab exporter script
        run: ./gitlab-exporter.sh

      - name: List Output Directory
        run: ls -la output

      - name: Upload Exported Archive
        uses: actions/upload-artifact@v3
        with:
          name: migration_archive
          path: output/migration_archive.tar.gz
